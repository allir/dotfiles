#!/usr/bin/env bash
set -euo pipefail

# This is pretty ugly, but it works on macOS without requiring coreutils for GNU readlink
# Ideally this would be:
# SCRIPT=$( readlink -f ${BASH_SOURCE[0]} )
SCRIPT=$( cd "$( dirname "${BASH_SOURCE[0]}" )" &>/dev/null && pwd )/$( basename "${BASH_SOURCE[0]}" )
SCRIPTPATH=$( dirname "${SCRIPT}" )

# Parse arguments
MIGRATE=false
for arg in "$@"; do
    case "$arg" in
        --migrate) MIGRATE=true ;;
        *) echo "Unknown argument: $arg"; exit 1 ;;
    esac
done

# Detect legacy (pre-stow) symlinks pointing to dotfiles root
has_legacy_symlinks() {
    for link in "$HOME"/.*; do
        if [ -L "$link" ]; then
            target="$(readlink "$link")"
            if [[ "$target" == "${SCRIPTPATH}/".*  && "$target" != "${SCRIPTPATH}/stow/"* ]]; then
                return 0
            fi
        fi
    done
    return 1
}

# Remove legacy symlinks so stow can take over
migrate_legacy_symlinks() {
    echo "Removing legacy symlinks..."
    for link in "$HOME"/.*; do
        if [ -L "$link" ]; then
            target="$(readlink "$link")"
            if [[ "$target" == "${SCRIPTPATH}/".*  && "$target" != "${SCRIPTPATH}/stow/"* ]]; then
                echo "  rm $link (was â†’ $target)"
                rm "$link"
            fi
        fi
    done
    # Old SSH config symlink
    if [ -L "$HOME/.ssh/config" ]; then
        echo "  rm $HOME/.ssh/config"
        rm "$HOME/.ssh/config"
    fi
    # Old bin/ symlinks
    for link in "$HOME/.local/bin/"*; do
        if [ -L "$link" ] && [[ "$(readlink "$link")" == "${SCRIPTPATH}/bin/"* ]]; then
            echo "  rm $link"
            rm "$link"
        fi
    done
}

# Handle legacy symlink migration
if has_legacy_symlinks; then
    if [[ "$MIGRATE" == true ]]; then
        migrate_legacy_symlinks
    else
        echo "Legacy (pre-stow) symlinks detected. Run with --migrate to clean up old symlinks and switch to stow."
        exit 1
    fi
fi

# Ask for the administrator password upfront
sudo -v
# Keep-alive: update existing `sudo` time stamp until finished
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

case $(uname -s) in
    "Darwin" )
        echo "Starting Installation (Darwin)..."
        # Install xcode command line tools
        echo "Setting up xcode command line tools"
        if ! [[ -e "/Library/Developer/CommandLineTools/usr/bin/git" ]]; then
          xcode-select --install 2>/dev/null || true
          echo "Waiting for xcode command line tools installation to finish..."
          until [[ -e "/Library/Developer/CommandLineTools/usr/bin/git" ]]; do
            sleep 5
          done
        fi

        # Ensure latest version of .dotfiles repo
        echo "Updating dotfiles repository..."
        pushd "${SCRIPTPATH}"
        git pull --ff-only || echo "Warning: could not update dotfiles repo (local changes?)"
        popd

        # Setup sudoers for user
        echo "Add user to passwordless sudoers"
        "${SCRIPTPATH}/libexec/setup_sudoers.sh"

        # Install Homebrew
        echo "Setting up Homebrew"
        "${SCRIPTPATH}/libexec/setup_homebrew.sh"
        if [ -f /opt/homebrew/bin/brew ]; then
            eval "$(/opt/homebrew/bin/brew shellenv)"
        elif [ -f /usr/local/bin/brew ]; then
            eval "$(/usr/local/bin/brew shellenv)"
        fi

        # Install  Formulae & Casks
        echo "Installing Formulae and Casks from Brewfile bundle"
        brew bundle --file="${SCRIPTPATH}/Brewfile" || true

        # Install Claude Code CLI
        echo "Installing Claude Code"
        "${SCRIPTPATH}/libexec/setup_claude.sh"

        # Add homebrew bash and zsh to /etc/shells and change shell
        if ! ( grep "${HOMEBREW_PREFIX}/bin/bash" /etc/shells &>/dev/null ); then
            echo "Adding bash to /etc/shells"
            echo "${HOMEBREW_PREFIX}/bin/bash" | sudo tee -a /etc/shells > /dev/null
        fi
        if ! ( grep "${HOMEBREW_PREFIX}/bin/zsh" /etc/shells &>/dev/null ); then
            echo "Adding zsh to /etc/shells"
            echo "${HOMEBREW_PREFIX}/bin/zsh" | sudo tee -a /etc/shells > /dev/null
            sudo chmod -R 755 "${HOMEBREW_PREFIX}/share/zsh" &>/dev/null
        fi
        sudo chsh -s "${HOMEBREW_PREFIX}/bin/zsh" "$(whoami)"

        # Symlink dotfiles with stow
        echo "Symlinking dotfiles with stow"
        ( umask 077 && mkdir -p "${HOME}/.ssh/config.d" )
        mkdir -p "${HOME}/.local/bin"
        stow -d "${SCRIPTPATH}/stow" -t "${HOME}" --restow \
            shell git vim tmux screen ssh bin
        stow -d "${SCRIPTPATH}/stow" -t "${HOME}" --restow iterm

        # Configure iTerm2
        echo "Configuring iTerm2"
        "${SCRIPTPATH}/libexec/setup_iterm.sh"

        # Configure Dock
        echo "Configuring macOS Dock"
        "${SCRIPTPATH}/libexec/macos/configure_dock.sh"
        ;;

    "Linux" )
        echo "Starting Installation (Linux)..."
        # Setup sudoers for user
        echo "Add user to passwordless sudoers"
        "${SCRIPTPATH}/libexec/setup_sudoers.sh"

        # Symlink dotfiles with stow
        echo "Symlinking dotfiles with stow"
        ( umask 077 && mkdir -p "${HOME}/.ssh/config.d" )
        mkdir -p "${HOME}/.local/bin"
        stow -d "${SCRIPTPATH}/stow" -t "${HOME}" --restow \
            shell git vim tmux screen ssh bin
        ;;
esac

if [[ $(uname -s) == "Darwin" ]]; then
    # Configure macOS Terminal
    # Note that this will kill the Terminal to save changes
    echo "Configuring macOS Terminal"
    "${SCRIPTPATH}/libexec/macos/configure_terminal.sh"
fi
